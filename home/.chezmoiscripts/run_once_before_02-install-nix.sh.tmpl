{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 02-INSTALL-NIX (Universal - 2025/2026 Best Practices)
# Nix package manager with flakes support via Determinate Systems installer
# Works on: Arch, Ubuntu, Debian, Fedora, RHEL, openSUSE, Alpine, NixOS, WSL2
# ==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  ❄️  Nix Package Manager Installation${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# ==============================================================================
# Check if already installed
# ==============================================================================
if command -v nix &>/dev/null; then
    log_success "Nix already installed: $(nix --version 2>/dev/null || echo 'unknown')"
    
    # Ensure flakes are enabled
    if [ -d "$HOME/.config/nix" ]; then
        if ! grep -q "experimental-features" "$HOME/.config/nix/nix.conf" 2>/dev/null; then
            mkdir -p "$HOME/.config/nix"
            echo "experimental-features = nix-command flakes" >> "$HOME/.config/nix/nix.conf"
            log_info "Enabled flakes in user config"
        fi
    fi
    exit 0
fi

# ==============================================================================
# Skip in certain environments
# ==============================================================================
{{ if or .is_codespaces .is_devcontainer -}}
log_info "Container environment detected - using lightweight Nix setup"
{{ end -}}

# Check if we're on NixOS (Nix is already there)
if [ -f /etc/NIXOS ]; then
    log_success "Running on NixOS - Nix is already available"
    exit 0
fi

# ==============================================================================
# Install dependencies for Nix installation
# ==============================================================================
log_info "Ensuring curl is available..."

# Detect package manager and install curl if needed
if ! command -v curl &>/dev/null; then
    if command -v apt-get &>/dev/null; then
        sudo apt-get update -qq && sudo apt-get install -y -qq curl
    elif command -v pacman &>/dev/null; then
        sudo pacman -S --needed --noconfirm curl
    elif command -v dnf &>/dev/null; then
        sudo dnf install -y curl
    elif command -v zypper &>/dev/null; then
        sudo zypper --non-interactive install curl
    elif command -v apk &>/dev/null; then
        sudo apk add --no-cache curl
    fi
fi

# ==============================================================================
# Install Nix via Determinate Systems installer
# ==============================================================================
log_info "Installing Nix via Determinate Systems installer..."
log_info "This installer provides:"
log_info "  • Flakes enabled by default"
log_info "  • Better uninstall support"
log_info "  • Works on all major distros"
log_info "  • SELinux compatible"

# Use Determinate Systems installer (2025/2026 best practice)
# https://github.com/DeterminateSystems/nix-installer
if curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm; then
    log_success "Nix installation completed"
else
    log_error "Nix installation failed"
    log_info "Trying alternative installation method..."
    
    # Fallback to official installer
    sh <(curl -L https://nixos.org/nix/install) --daemon --yes || {
        log_error "All installation methods failed"
        exit 1
    }
fi

# ==============================================================================
# Source Nix environment
# ==============================================================================
log_info "Loading Nix environment..."

# Try different profile locations
for profile in \
    "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" \
    "/etc/profile.d/nix.sh" \
    "$HOME/.nix-profile/etc/profile.d/nix.sh"
do
    if [ -e "$profile" ]; then
        . "$profile"
        log_info "Loaded profile: $profile"
        break
    fi
done

# ==============================================================================
# Configure Nix for flakes (user-level)
# ==============================================================================
mkdir -p "$HOME/.config/nix"
if [ ! -f "$HOME/.config/nix/nix.conf" ]; then
    cat > "$HOME/.config/nix/nix.conf" << 'EOF'
# Nix configuration (2025/2026 best practices)
experimental-features = nix-command flakes
warn-dirty = false
accept-flake-config = true
auto-optimise-store = true
EOF
    log_info "Created user Nix configuration with flakes enabled"
fi

# ==============================================================================
# Verify installation
# ==============================================================================
if command -v nix &>/dev/null; then
    log_success "Nix installed successfully: $(nix --version)"
    
    # Test flakes support
    if nix flake --help &>/dev/null; then
        log_success "Flakes support verified"
    fi
else
    log_error "Nix installation verification failed"
    log_warn "You may need to restart your shell or run:"
    log_warn "  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
fi
{{ end -}}
