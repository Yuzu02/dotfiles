{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 03-INSTALL-SHELL-TOOLS (FIXED)
# Modern shell tools: zsh, starship, zoxide, atuin, fzf, direnv
# ==============================================================================

set -euo pipefail

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  ðŸš Installing Shell Tools${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ============================================================================
# SUDO WRAPPER
# ============================================================================
if [ "$(id -u)" -eq 0 ]; then
    SUDO=""
else
    SUDO="sudo"
fi

# ============================================================================
# PACKAGE MANAGER DETECTION
# ============================================================================
if command -v paru &>/dev/null; then
    PKG_INSTALL="paru -S --needed --noconfirm"
elif command -v yay &>/dev/null; then
    PKG_INSTALL="yay -S --needed --noconfirm"
elif command -v pacman &>/dev/null; then
    PKG_INSTALL="$SUDO pacman -S --needed --noconfirm"
elif command -v apt-get &>/dev/null; then
    PKG_INSTALL="$SUDO apt-get install -y"
elif command -v dnf &>/dev/null; then
    PKG_INSTALL="$SUDO dnf install -y"
else
    echo -e "${YELLOW}[WARN]${NC} No supported package manager found - skipping native package installation"
    PKG_INSTALL=""
fi

# ============================================================================
# INSTALL ZSH FIRST (CRITICAL FIX)
# ============================================================================
echo -e "${BLUE}[INFO]${NC} Installing zsh..."
if ! command -v zsh &>/dev/null; then
    if [ -n "$PKG_INSTALL" ]; then
        $PKG_INSTALL zsh &>/dev/null || {
            echo -e "${YELLOW}âš  Could not install zsh via package manager${NC}"
        }
    fi
fi

# Verify zsh is installed
if ! command -v zsh &>/dev/null; then
    echo -e "${YELLOW}âš  zsh not found - skipping Oh My Zsh and shell tools${NC}"
    exit 0
fi

echo -e "${GREEN}âœ“${NC} zsh installed"

# ============================================================================
# INSTALL SHELL PACKAGES
# ============================================================================
if [ -n "$PKG_INSTALL" ]; then
    if command -v pacman &>/dev/null; then
        # Arch Linux
        SHELL_PKGS=(
            starship
            zoxide
            atuin
            fzf
            direnv
            carapace
        )
        $PKG_INSTALL "${SHELL_PKGS[@]}" &>/dev/null 2>&1 || {
            echo -e "${YELLOW}âš  Some packages may have failed, continuing...${NC}"
        }
    elif command -v apt-get &>/dev/null; then
        # Ubuntu/Debian
        $SUDO apt-get update &>/dev/null
        SHELL_PKGS=(
            fzf
            direnv
        )
        $PKG_INSTALL "${SHELL_PKGS[@]}" &>/dev/null 2>&1
        
        # Install starship via curl
        if ! command -v starship &>/dev/null; then
            curl -sS https://starship.rs/install.sh | sh -s -- -y &>/dev/null
        fi
        
        # Install zoxide via curl
        if ! command -v zoxide &>/dev/null; then
            curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash &>/dev/null
        fi
        
        # Install atuin via curl
        if ! command -v atuin &>/dev/null; then
            curl -sS https://raw.githubusercontent.com/atuinsh/atuin/main/install.sh | bash &>/dev/null
        fi
        
    elif command -v dnf &>/dev/null; then
        # Fedora/RHEL
        SHELL_PKGS=(
            starship
            fzf
            direnv
        )
        $PKG_INSTALL "${SHELL_PKGS[@]}" &>/dev/null 2>&1
        
        # Install zoxide
        if ! command -v zoxide &>/dev/null; then
            curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash &>/dev/null
        fi
        
        # Install atuin
        if ! command -v atuin &>/dev/null; then
            curl -sS https://raw.githubusercontent.com/atuinsh/atuin/main/install.sh | bash &>/dev/null
        fi
    fi
fi

# ============================================================================
# INSTALL OH MY ZSH (FIXED: Only if zsh exists)
# ============================================================================
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo -e "${BLUE}[INFO]${NC} Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended &>/dev/null
    echo -e "${GREEN}âœ“${NC} Oh My Zsh installed"
else
    echo -e "${GREEN}âœ“${NC} Oh My Zsh already installed"
fi

# ============================================================================
# INSTALL ZSH PLUGINS
# ============================================================================
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

# zsh-autosuggestions
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    git clone --quiet https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions" 2>/dev/null
    echo -e "${GREEN}âœ“${NC} zsh-autosuggestions installed"
fi

# zsh-syntax-highlighting
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    git clone --quiet https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" 2>/dev/null
    echo -e "${GREEN}âœ“${NC} zsh-syntax-highlighting installed"
fi

# you-should-use
if [ ! -d "$ZSH_CUSTOM/plugins/you-should-use" ]; then
    git clone --quiet https://github.com/MichaelAquilina/zsh-you-should-use.git "$ZSH_CUSTOM/plugins/you-should-use" 2>/dev/null
    echo -e "${GREEN}âœ“${NC} you-should-use installed"
fi

echo -e "${GREEN}âœ“ Shell tools installed${NC}"
{{ end -}}