{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 00-SETUP-LINUX-FRESH (Universal - 2025/2026 Best Practices)
# Bootstrap script for fresh Linux installations
# Handles: sudo installation, user creation, package manager setup
# 
# KEY DESIGN DECISIONS:
# 1. If running as root on fresh install ğŸ› ï¸ setup system, create user, EXIT
# 2. User must then login as regular user and re-run chezmoi
# 3. This avoids all permission issues with su/sudo during chezmoi run
# ==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  ğŸ—ï¸  Fresh Linux Bootstrap${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ============================================================================
# DETECT LINUX DISTRIBUTION
# ============================================================================
DISTRO="unknown"
if [ -f /etc/os-release ]; then
    . /etc/os-release
    DISTRO="${ID:-unknown}"
    log_info "Detected distribution: $DISTRO"
else
    log_warn "Cannot detect Linux distribution from /etc/os-release"
fi

# ============================================================================
# DETECT IF RUNNING AS ROOT
# ============================================================================
IS_ROOT=false
IS_FRESH_INSTALL=false
GITHUB_USER="{{ .github_user }}"

if [ "$(id -u)" -eq 0 ]; then
    IS_ROOT=true
    log_info "Running as root"
fi

# Check if this is a fresh install (no sudo available)
if ! command -v sudo &>/dev/null; then
    IS_FRESH_INSTALL=true
    log_info "Detected fresh installation (no sudo)"
fi

# ============================================================================
# NORMAL USER PATH: Already configured, just exit
# ============================================================================
if [ "$IS_ROOT" = false ]; then
    if command -v sudo &>/dev/null; then
        log_success "System already configured - running as regular user with sudo"
        exit 0
    else
        log_error "Not running as root but sudo is not available!"
        log_info "Please run as root first to bootstrap the system."
        exit 1
    fi
fi

# ============================================================================
# ROOT PATH: Bootstrap fresh system
# ============================================================================
if [ "$IS_ROOT" = true ]; then
    log_info "Starting fresh Linux bootstrap as root..."
    
    # ========================================================================
    # DISTRIBUTION-SPECIFIC BOOTSTRAP
    # ========================================================================
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            log_info "Bootstrapping Arch-based Linux..."
            
            # Initialize pacman keyring
            log_info "Initializing pacman keyring..."
            pacman-key --init 2>/dev/null || true
            pacman-key --populate archlinux 2>/dev/null || true
            log_success "Pacman keyring initialized"
            
            # Update system
            log_info "Updating system packages..."
            pacman -Syu --noconfirm 2>/dev/null || pacman -Sy --noconfirm
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            pacman -S --needed --noconfirm \
                base-devel git curl wget sudo vim \
                man-db man-pages openssh unzip zip \
                tar gzip xdg-utils less 2>/dev/null || true
            log_success "Essential packages installed"
            
            # Configure sudo for wheel group
            log_info "Configuring sudo..."
            if [ ! -f /etc/sudoers.d/wheel ]; then
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
            fi
            log_success "Sudo configured for wheel group"
            ;;
            
        ubuntu|debian|linuxmint|pop)
            log_info "Bootstrapping Debian-based Linux..."
            
            # Update package lists
            log_info "Updating package lists..."
            apt-get update 2>/dev/null || true
            log_success "Package lists updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential git curl wget sudo vim \
                man-db manpages openssh-client unzip zip \
                tar gzip xdg-utils less ca-certificates 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        fedora|rhel|centos|rocky|almalinux)
            log_info "Bootstrapping Fedora/RHEL-based Linux..."
            
            # Update system
            log_info "Updating system packages..."
            dnf upgrade -y 2>/dev/null || yum upgrade -y 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            dnf install -y \
                @development-tools git curl wget sudo vim \
                man-db man-pages openssh-clients unzip zip \
                tar gzip xdg-utils less 2>/dev/null || \
            yum install -y \
                git curl wget sudo vim \
                man-db man-pages openssh-clients unzip zip \
                tar gzip less 2>/dev/null || true
            log_success "Essential packages installed"
            
            # Configure sudo for wheel group
            log_info "Configuring sudo..."
            if [ ! -f /etc/sudoers.d/wheel ]; then
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
            fi
            log_success "Sudo configured for wheel group"
            ;;
            
        opensuse*|suse*)
            log_info "Bootstrapping openSUSE/SUSE Linux..."
            
            # Update system
            log_info "Updating system packages..."
            zypper refresh 2>/dev/null || true
            zypper update -y 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            zypper install -y \
                -t pattern devel_basis \
                git curl wget sudo vim \
                man man-pages openssh unzip zip \
                tar gzip xdg-utils less 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        alpine)
            log_info "Bootstrapping Alpine Linux..."
            
            # Update package lists
            log_info "Updating package lists..."
            apk update 2>/dev/null || true
            log_success "Package lists updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            apk add --no-cache \
                build-base git curl wget sudo vim \
                man-db man-pages openssh-client unzip zip \
                tar gzip xdg-utils less bash 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        void)
            log_info "Bootstrapping Void Linux..."
            
            # Update system
            log_info "Updating system packages..."
            xbps-install -Syu 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            xbps-install -y \
                base-devel git curl wget sudo vim \
                man-db man-pages openssh unzip zip \
                tar gzip xdg-utils 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        nixos)
            log_info "NixOS detected - packages managed by NixOS configuration"
            log_success "Skipping package installation on NixOS"
            ;;
            
        *)
            log_warn "Unknown distribution: $DISTRO"
            log_info "Attempting generic setup..."
            
            # Try common package managers
            if command -v apt-get &>/dev/null; then
                apt-get update && apt-get install -y sudo git curl 2>/dev/null || true
            elif command -v dnf &>/dev/null; then
                dnf install -y sudo git curl 2>/dev/null || true
            elif command -v pacman &>/dev/null; then
                pacman -S --noconfirm sudo git curl 2>/dev/null || true
            fi
            ;;
    esac
    
    # ========================================================================
    # CREATE REGULAR USER IF RUNNING AS ROOT
    # ========================================================================
    # Determine target username
    TARGET_USER=""
    if [ -n "$GITHUB_USER" ] && [ "$GITHUB_USER" != "root" ] && [ "$GITHUB_USER" != "" ]; then
        TARGET_USER="$GITHUB_USER"
    elif [ -n "${SUDO_USER:-}" ] && [ "$SUDO_USER" != "root" ]; then
        TARGET_USER="$SUDO_USER"
    else
        # Fallback: use "yuzu" as default
        TARGET_USER="yuzu"
    fi
    
    # Normalize username (lowercase, remove special chars)
    TARGET_USER=$(echo "$TARGET_USER" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]_-')
    
    log_info "Target user: $TARGET_USER"
    
    # Create user if doesn't exist
    if ! id "$TARGET_USER" &>/dev/null 2>&1; then
        log_info "Creating user: $TARGET_USER"
        
        case "$DISTRO" in
            arch|archlinux|endeavouros|manjaro|fedora|rhel|centos|rocky|almalinux)
                useradd -m -G wheel -s /bin/bash "$TARGET_USER" 2>/dev/null || \
                useradd -m -G wheel "$TARGET_USER" 2>/dev/null || true
                ;;
            ubuntu|debian|linuxmint|pop)
                useradd -m -G sudo -s /bin/bash "$TARGET_USER" 2>/dev/null || \
                useradd -m -G sudo "$TARGET_USER" 2>/dev/null || true
                ;;
            alpine)
                adduser -D -s /bin/bash "$TARGET_USER" 2>/dev/null || \
                adduser -D "$TARGET_USER" 2>/dev/null || true
                addgroup "$TARGET_USER" wheel 2>/dev/null || true
                ;;
            *)
                useradd -m -s /bin/bash "$TARGET_USER" 2>/dev/null || true
                ;;
        esac
        
        # Set a random temporary password
        TEMP_PASS=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16)
        echo "$TARGET_USER:$TEMP_PASS" | chpasswd 2>/dev/null || true
        
        log_success "User $TARGET_USER created"
        log_warn "Temporary password: $TEMP_PASS"
        log_warn "Please change it immediately after login with: passwd"
    else
        log_info "User $TARGET_USER already exists"
    fi
    
    # Ensure user is in correct group
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro|fedora|rhel|centos|rocky|almalinux)
            usermod -aG wheel "$TARGET_USER" 2>/dev/null || true
            ;;
        ubuntu|debian|linuxmint|pop)
            usermod -aG sudo "$TARGET_USER" 2>/dev/null || true
            ;;
    esac
    
    # ========================================================================
    # CONFIGURE LOCALES
    # ========================================================================
    log_info "Configuring locales..."
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            if [ -f /etc/locale.gen ]; then
                sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen 2>/dev/null || true
                locale-gen 2>/dev/null || true
            fi
            if [ ! -f /etc/locale.conf ]; then
                echo "LANG=en_US.UTF-8" > /etc/locale.conf
            fi
            ;;
        ubuntu|debian|linuxmint|pop)
            locale-gen en_US.UTF-8 2>/dev/null || true
            update-locale LANG=en_US.UTF-8 2>/dev/null || true
            ;;
        fedora|rhel|centos|rocky|almalinux)
            localectl set-locale LANG=en_US.UTF-8 2>/dev/null || true
            ;;
    esac
    log_success "Locales configured"
    
    # ========================================================================
    # OPTIMIZE PACKAGE MANAGER
    # ========================================================================
    log_info "Optimizing package manager..."
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            if [ -f /etc/pacman.conf ]; then
                sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 10/' /etc/pacman.conf 2>/dev/null || true
                sed -i 's/#Color/Color/' /etc/pacman.conf 2>/dev/null || true
                sed -i 's/#VerbosePkgLists/VerbosePkgLists/' /etc/pacman.conf 2>/dev/null || true
            fi
            ;;
        fedora|rhel|centos|rocky|almalinux)
            if [ -f /etc/dnf/dnf.conf ]; then
                grep -q "^fastestmirror=" /etc/dnf/dnf.conf || echo "fastestmirror=True" >> /etc/dnf/dnf.conf
                grep -q "^max_parallel_downloads=" /etc/dnf/dnf.conf || echo "max_parallel_downloads=10" >> /etc/dnf/dnf.conf
            fi
            ;;
    esac
    log_success "Package manager optimized"
    
    # ========================================================================
    # INSTALL CHEZMOI FOR TARGET USER
    # ========================================================================
    log_info "Installing chezmoi for $TARGET_USER..."
    
    # Get the chezmoi binary path
    CHEZMOI_BIN=""
    if command -v chezmoi &>/dev/null; then
        CHEZMOI_BIN=$(command -v chezmoi)
    elif [ -f "$HOME/bin/chezmoi" ]; then
        CHEZMOI_BIN="$HOME/bin/chezmoi"
    elif [ -f "/root/bin/chezmoi" ]; then
        CHEZMOI_BIN="/root/bin/chezmoi"
    fi
    
    # Copy chezmoi to a system-wide location
    if [ -n "$CHEZMOI_BIN" ] && [ -f "$CHEZMOI_BIN" ]; then
        cp "$CHEZMOI_BIN" /usr/local/bin/chezmoi 2>/dev/null || true
        chmod +x /usr/local/bin/chezmoi 2>/dev/null || true
        log_success "Chezmoi installed to /usr/local/bin/chezmoi"
    fi
    
    # ========================================================================
    # AUTOMATIC CONTINUATION AS TARGET USER
    # ========================================================================
    log_info "Setting up automatic continuation for $TARGET_USER..."
    
    USER_HOME=$(getent passwd "$TARGET_USER" | cut -d: -f6)
    if [ -z "$USER_HOME" ]; then
        USER_HOME="/home/$TARGET_USER"
    fi
    
    # Create the continuation script
    CONTINUE_SCRIPT="$USER_HOME/.chezmoi-continue.sh"
    
    cat > "$CONTINUE_SCRIPT" << 'INNEREOF'
#!/bin/bash
# Auto-generated chezmoi continuation script
# This runs as the target user to complete setup

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  ğŸš€ Continuing Chezmoi Setup...${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Ensure PATH includes common locations
export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"

# Provide non-interactive defaults so templates don't prompt during continuation
# Prefer any existing CHEZMOI_* env vars (for CI/manual overrides), otherwise
# fall back to sensible defaults derived from the GitHub username placeholder.
export CHEZMOI_GITHUB_USER="__GITHUB_USER_PLACEHOLDER__"
export CHEZMOI_EMAIL="${CHEZMOI_EMAIL:-${CHEZMOI_GITHUB_USER}@localhost}"
export CHEZMOI_NAME="${CHEZMOI_NAME:-${CHEZMOI_GITHUB_USER}}"

# Also export these as plain variables used by some scripts
GITHUB_USER="$CHEZMOI_GITHUB_USER"


# Source Nix if available
for profile in \
    "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" \
    "/etc/profile.d/nix.sh" \
    "$HOME/.nix-profile/etc/profile.d/nix.sh"
do
    [ -e "$profile" ] && . "$profile" && break
done

# Run chezmoi init
GITHUB_USER="__GITHUB_USER_PLACEHOLDER__"

if command -v chezmoi &>/dev/null; then
    echo -e "${BLUE}[INFO]${NC} Running non-interactive chezmoi init --apply $GITHUB_USER"
    chezmoi init --apply "$GITHUB_USER"
else
    echo -e "${BLUE}[INFO]${NC} Installing chezmoi and applying dotfiles (non-interactive)..."
    # Run installer which will place chezmoi in PATH, then re-run init using our env defaults
    sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply "$GITHUB_USER"
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  âœ… Chezmoi Setup Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Self-destruct
rm -f "$0"
INNEREOF

    # Replace placeholder with actual github user
    sed -i "s/__GITHUB_USER_PLACEHOLDER__/$GITHUB_USER/g" "$CONTINUE_SCRIPT"
    
    chmod +x "$CONTINUE_SCRIPT"
    chown "$TARGET_USER:$TARGET_USER" "$CONTINUE_SCRIPT" 2>/dev/null || \
    chown "$TARGET_USER" "$CONTINUE_SCRIPT" 2>/dev/null || true
    
    log_success "Continuation script created at $CONTINUE_SCRIPT"
    
    # ========================================================================
    # TRY AUTOMATIC CONTINUATION
    # ========================================================================
    echo ""
    log_info "Attempting automatic continuation as $TARGET_USER..."
    echo ""
    
    # Run the continuation script as the target user
    if su - "$TARGET_USER" -c "bash '$CONTINUE_SCRIPT'" 2>&1; then
        echo ""
        log_success "ğŸ‰ Full setup completed successfully!"
        echo ""
        echo -e "${BOLD}Your environment is ready. Please:${NC}"
        echo -e "  1. ${YELLOW}Log out of root${NC}"
        echo -e "  2. ${YELLOW}Log in as: ${CYAN}$TARGET_USER${NC}"
        echo -e "  3. ${YELLOW}Change your password:${NC} ${CYAN}passwd${NC}"
        echo ""
    else
        echo ""
        log_warn "Automatic continuation encountered issues."
        echo ""
        echo -e "${BOLD}Please complete setup manually:${NC}"
        echo -e "  1. ${YELLOW}Log out of root${NC}"
        echo -e "  2. ${YELLOW}Log in as: ${CYAN}$TARGET_USER${NC}"
        echo -e "  3. ${YELLOW}Run:${NC} ${CYAN}chezmoi init --apply $GITHUB_USER${NC}"
        echo ""
    fi
    
    # Exit - don't let chezmoi continue as root
    exit 0
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  âœ… Bootstrap Phase Complete${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
{{ end -}}
