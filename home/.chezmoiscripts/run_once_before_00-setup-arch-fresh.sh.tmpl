{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 00-SETUP-LINUX-FRESH
# Bootstrap script for fresh Linux installations (Arch, Ubuntu, Fedora)
# Handles: sudo installation, user creation, package manager setup, base packages
# ==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  ğŸ—ï¸  Fresh Linux Bootstrap${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ============================================================================
# DETECT LINUX DISTRIBUTION
# ============================================================================
if [ -f /etc/os-release ]; then
    . /etc/os-release
    DISTRO=$ID
    log_info "Detected distribution: $DISTRO"
else
    log_error "Cannot detect Linux distribution"
    exit 1
fi

# ============================================================================
# DETECT IF RUNNING AS ROOT
# ============================================================================
IS_ROOT=false
IS_FRESH_INSTALL=false

if [ "$(id -u)" -eq 0 ]; then
    IS_ROOT=true
    log_info "Running as root"
fi

# Check if this is a fresh install (no sudo)
if ! command -v sudo &>/dev/null; then
    IS_FRESH_INSTALL=true
    log_info "Detected fresh installation (no sudo)"
fi

# ============================================================================
# SKIP IF ALREADY CONFIGURED
# ============================================================================
if [ "$IS_ROOT" = false ] || [ "$IS_FRESH_INSTALL" = false ]; then
    if command -v sudo &>/dev/null; then
        log_success "System already configured (sudo available)"
        exit 0
    fi
fi

# ============================================================================
# FRESH INSTALL BOOTSTRAP
# ============================================================================
if [ "$IS_ROOT" = true ] && [ "$IS_FRESH_INSTALL" = true ]; then
    log_info "Starting fresh Linux bootstrap..."
    
    # ============================================================================
    # DISTRIBUTION-SPECIFIC BOOTSTRAP
    # ============================================================================
    case "$DISTRO" in
        arch|archlinux)
            log_info "Bootstrapping Arch Linux..."
            
            # Initialize pacman keyring
            log_info "Initializing pacman keyring..."
            pacman-key --init &>/dev/null || true
            pacman-key --populate archlinux &>/dev/null || true
            log_success "Pacman keyring initialized"
            
            # Update system
            log_info "Updating system packages..."
            pacman -Syu --noconfirm &>/dev/null
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            pacman -S --needed --noconfirm \
                base-devel git curl wget sudo vim \
                man-db man-pages openssh unzip zip \
                tar gzip xdg-utils less &>/dev/null
            log_success "Essential packages installed"
            ;;
            
        ubuntu|debian)
            log_info "Bootstrapping Ubuntu/Debian..."
            
            # Update package lists
            log_info "Updating package lists..."
            apt-get update &>/dev/null
            log_success "Package lists updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential git curl wget sudo vim \
                man-db manpages openssh-client unzip zip \
                tar gzip xdg-utils less ca-certificates &>/dev/null
            log_success "Essential packages installed"
            ;;
            
        fedora|rhel|centos)
            log_info "Bootstrapping Fedora/RHEL..."
            
            # Update system
            log_info "Updating system packages..."
            dnf upgrade -y &>/dev/null
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            dnf install -y \
                @development-tools git curl wget sudo vim \
                man-db man-pages openssh-clients unzip zip \
                tar gzip xdg-utils less &>/dev/null
            log_success "Essential packages installed"
            ;;
            
        *)
            log_warn "Unknown distribution: $DISTRO"
            log_info "Attempting generic setup..."
            ;;
    esac
    
    # 4. Configure sudo for wheel/sudo group
    log_info "Configuring sudo..."
    if [ ! -f /etc/sudoers.d/wheel ] && [ ! -f /etc/sudoers.d/sudo ]; then
        case "$DISTRO" in
            arch|archlinux)
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
                log_success "Sudo configured for wheel group"
                ;;
            ubuntu|debian)
                # Sudo group already configured by default on Debian/Ubuntu
                log_success "Sudo group already configured"
                ;;
            fedora|rhel|centos)
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
                log_success "Sudo configured for wheel group"
                ;;
        esac
    fi
    
    # 5. Create user automatically if running as root
    CHEZMOI_USER="{{ .chezmoi.username }}"
    GITHUB_USER="{{ .github_user }}"
    
    if [ "$CHEZMOI_USER" = "root" ]; then
        log_warn "Running as root - creating a regular user automatically"
        
        # Use github username as default username
        if [ -n "$GITHUB_USER" ] && [ "$GITHUB_USER" != "root" ]; then
            NEW_USER="$GITHUB_USER"
        else
            NEW_USER="yuzu"
        fi
        
        # Create user if doesn't exist
        if ! id "$NEW_USER" &>/dev/null 2>&1; then
            log_info "Creating user: $NEW_USER"
            
            case "$DISTRO" in
                arch|archlinux|fedora|rhel|centos)
                    useradd -m -G wheel -s /bin/bash "$NEW_USER"
                    ;;
                ubuntu|debian)
                    useradd -m -G sudo -s /bin/bash "$NEW_USER"
                    ;;
            esac
            
            # Set a temporary password (user should change it)
            echo "$NEW_USER:changeme" | chpasswd
            log_warn "Temporary password set to 'changeme' - please change it after login!"
            log_success "User $NEW_USER created"
        else
            log_info "User $NEW_USER already exists"
        fi
        
        # Ensure user is in correct group
        case "$DISTRO" in
            arch|archlinux|fedora|rhel|centos)
                if ! groups "$NEW_USER" | grep -q wheel; then
                    usermod -aG wheel "$NEW_USER"
                    log_success "Added $NEW_USER to wheel group"
                fi
                ;;
            ubuntu|debian)
                if ! groups "$NEW_USER" | grep -q sudo; then
                    usermod -aG sudo "$NEW_USER"
                    log_success "Added $NEW_USER to sudo group"
                fi
                ;;
        esac
        
        # Create flag file to indicate we need to switch user
        echo "$NEW_USER" > /tmp/.chezmoi-switch-user
        
    else
        # Ensure user is in correct group
        if id "$CHEZMOI_USER" &>/dev/null; then
            case "$DISTRO" in
                arch|archlinux|fedora|rhel|centos)
                    if ! groups "$CHEZMOI_USER" | grep -q wheel; then
                        usermod -aG wheel "$CHEZMOI_USER"
                        log_success "Added $CHEZMOI_USER to wheel group"
                    fi
                    ;;
                ubuntu|debian)
                    if ! groups "$CHEZMOI_USER" | grep -q sudo; then
                        usermod -aG sudo "$CHEZMOI_USER"
                        log_success "Added $CHEZMOI_USER to sudo group"
                    fi
                    ;;
            esac
        fi
    fi
    
    # 6. Configure locales
    log_info "Configuring locales..."
    case "$DISTRO" in
        arch|archlinux)
            if ! grep -q "^en_US.UTF-8 UTF-8" /etc/locale.gen; then
                sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
                locale-gen &>/dev/null
            fi
            if [ ! -f /etc/locale.conf ]; then
                cat > /etc/locale.conf << 'EOF'
LANG=en_US.UTF-8
LC_TIME=en_US.UTF-8
LC_COLLATE=C
EOF
            fi
            ;;
        ubuntu|debian)
            if ! locale -a | grep -q en_US.utf8; then
                locale-gen en_US.UTF-8 &>/dev/null || true
                update-locale LANG=en_US.UTF-8 &>/dev/null || true
            fi
            ;;
        fedora|rhel|centos)
            localectl set-locale LANG=en_US.UTF-8 &>/dev/null || true
            ;;
    esac
    log_success "Locales configured"
    
    # 7. Optimize package manager
    log_info "Optimizing package manager..."
    case "$DISTRO" in
        arch|archlinux)
            if ! grep -q "^ParallelDownloads" /etc/pacman.conf; then
                sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 10/' /etc/pacman.conf
                sed -i 's/#Color/Color/' /etc/pacman.conf
                sed -i 's/#VerbosePkgLists/VerbosePkgLists/' /etc/pacman.conf
            fi
            ;;
        ubuntu|debian)
            # Enable parallel downloads in apt
            if [ ! -f /etc/apt/apt.conf.d/99parallel ]; then
                echo 'Acquire::Queue-Mode "host";' > /etc/apt/apt.conf.d/99parallel
                echo 'Acquire::http::Pipeline-Depth "5";' >> /etc/apt/apt.conf.d/99parallel
            fi
            ;;
        fedora|rhel|centos)
            # Enable fastest mirror and parallel downloads
            if ! grep -q "^fastestmirror=" /etc/dnf/dnf.conf; then
                echo "fastestmirror=True" >> /etc/dnf/dnf.conf
                echo "max_parallel_downloads=10" >> /etc/dnf/dnf.conf
            fi
            ;;
    esac
    log_success "Package manager optimized"
    
    # 8. Install AUR helper (Arch only)
    if [ "$DISTRO" = "arch" ] || [ "$DISTRO" = "archlinux" ]; then
        if ! command -v paru &>/dev/null; then
            log_info "Installing paru (AUR helper)..."
            
            if [ "$(id -u)" -eq 0 ]; then
                log_warn "Cannot install paru as root - will be installed later"
                log_info "Run the following as a regular user to install paru:"
                echo -e "  ${YELLOW}cd /tmp && git clone https://aur.archlinux.org/paru.git${NC}"
                echo -e "  ${YELLOW}cd paru && makepkg -si${NC}"
            fi
        fi
    fi
    
    log_success "Fresh Linux bootstrap complete!"
    
    # Check if we need to switch user and continue automatically
    if [ -f /tmp/.chezmoi-switch-user ]; then
        NEW_USER=$(cat /tmp/.chezmoi-switch-user)
        rm -f /tmp/.chezmoi-switch-user
        
        log_info ""
        log_info "Switching to user $NEW_USER and continuing installation..."
        log_info ""
        
        # Copy chezmoi config to new user's home
        if [ -f /root/.config/chezmoi/chezmoi.toml ]; then
            mkdir -p /home/$NEW_USER/.config/chezmoi
            cp /root/.config/chezmoi/chezmoi.toml /home/$NEW_USER/.config/chezmoi/
            chown -R $NEW_USER:$NEW_USER /home/$NEW_USER/.config
        fi
        
        # Copy current chezmoi source to new user
        if [ -d /root/.local/share/chezmoi ]; then
            mkdir -p /home/$NEW_USER/.local/share
            cp -r /root/.local/share/chezmoi /home/$NEW_USER/.local/share/
            chown -R $NEW_USER:$NEW_USER /home/$NEW_USER/.local/share/chezmoi
        fi
        
        # Continue installation as new user
        log_info "Continuing installation as $NEW_USER..."
        su - $NEW_USER -c "chezmoi apply -v" || {
            log_warn "Continuing installation as $NEW_USER..."
            su - $NEW_USER -c "sh -c \"\$(curl -fsLS get.chezmoi.io)\" -- init --apply {{ .github_user }}"
        }
        
        log_success "Installation complete!"
        log_warn "Please change the password for $NEW_USER (currently: changeme)"
        echo -e "${YELLOW}passwd${NC}"
        exit 0
    fi
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  âœ… Bootstrap Phase Complete${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
{{ end -}}
