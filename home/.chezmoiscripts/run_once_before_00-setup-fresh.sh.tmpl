{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 00-SETUP-LINUX-FRESH (Universal - 2025/2026 Best Practices - FIXED)
# Bootstrap script for fresh Linux installations
# Handles: sudo installation, user creation, package manager setup
# 
# KEY DESIGN: This script only runs as root on truly fresh systems.
# For regular users, it exits immediately.
# ==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  ğŸ—¿ï¸ Fresh Linux Bootstrap${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ============================================================================
# DETECT LINUX DISTRIBUTION
# ============================================================================
DISTRO="unknown"
if [ -f /etc/os-release ]; then
    . /etc/os-release
    DISTRO="${ID:-unknown}"
    log_info "Detected distribution: $DISTRO"
else
    log_warn "Cannot detect Linux distribution from /etc/os-release"
fi

# ============================================================================
# DETECT IF RUNNING AS ROOT
# ============================================================================
IS_ROOT=false
GITHUB_USER="{{ .github_user }}"

if [ "$(id -u)" -eq 0 ]; then
    IS_ROOT=true
    log_info "Running as root"
fi

# ============================================================================
# NORMAL USER PATH: Already configured, just exit
# ============================================================================
if [ "$IS_ROOT" = false ]; then
    if command -v sudo &>/dev/null; then
        log_success "System already configured - running as regular user with sudo"
        exit 0
    else
        log_error "Not running as root but sudo is not available!"
        log_info "This should not happen in normal usage."
        log_info "If this is a fresh system, please run: su -c 'curl -fsLS get.chezmoi.io | sh -s -- init --apply ${GITHUB_USER}'"
        exit 1
    fi
fi

# ============================================================================
# ROOT PATH: Bootstrap fresh system (only if sudo doesn't exist)
# ============================================================================
if [ "$IS_ROOT" = true ]; then
    # Check if this is truly a fresh install
    if command -v sudo &>/dev/null; then
        log_success "Sudo already installed - system is already bootstrapped"
        log_info "Skipping fresh system setup"
        exit 0
    fi
    
    log_info "Starting fresh Linux bootstrap as root..."
    
    # ========================================================================
    # DISTRIBUTION-SPECIFIC BOOTSTRAP
    # ========================================================================
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            log_info "Bootstrapping Arch-based Linux..."
            
            # Initialize pacman keyring
            log_info "Initializing pacman keyring..."
            pacman-key --init 2>/dev/null || true
            pacman-key --populate archlinux 2>/dev/null || true
            log_success "Pacman keyring initialized"
            
            # Update system
            log_info "Updating system packages..."
            pacman -Syu --noconfirm 2>/dev/null || pacman -Sy --noconfirm
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            pacman -S --needed --noconfirm \
                base-devel git curl wget sudo vim \
                man-db man-pages openssh unzip zip \
                tar gzip xdg-utils less 2>/dev/null || true
            log_success "Essential packages installed"
            
            # Configure sudo for wheel group
            log_info "Configuring sudo..."
            if [ ! -f /etc/sudoers.d/wheel ]; then
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
            fi
            log_success "Sudo configured for wheel group"
            ;;
            
        ubuntu|debian|linuxmint|pop)
            log_info "Bootstrapping Debian-based Linux..."
            
            # Update package lists
            log_info "Updating package lists..."
            apt-get update 2>/dev/null || true
            log_success "Package lists updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential git curl wget sudo vim \
                man-db manpages openssh-client unzip zip \
                tar gzip xdg-utils less ca-certificates 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        fedora|rhel|centos|rocky|almalinux)
            log_info "Bootstrapping Fedora/RHEL-based Linux..."
            
            # Update system
            log_info "Updating system packages..."
            dnf upgrade -y 2>/dev/null || yum upgrade -y 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            dnf install -y \
                @development-tools git curl wget sudo vim \
                man-db man-pages openssh-clients unzip zip \
                tar gzip xdg-utils less 2>/dev/null || \
            yum install -y \
                git curl wget sudo vim \
                man-db man-pages openssh-clients unzip zip \
                tar gzip less 2>/dev/null || true
            log_success "Essential packages installed"
            
            # Configure sudo for wheel group
            log_info "Configuring sudo..."
            if [ ! -f /etc/sudoers.d/wheel ]; then
                echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
                chmod 440 /etc/sudoers.d/wheel
            fi
            log_success "Sudo configured for wheel group"
            ;;
            
        opensuse*|suse*)
            log_info "Bootstrapping openSUSE/SUSE Linux..."
            
            # Update system
            log_info "Updating system packages..."
            zypper refresh 2>/dev/null || true
            zypper update -y 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            zypper install -y \
                -t pattern devel_basis \
                git curl wget sudo vim \
                man man-pages openssh unzip zip \
                tar gzip xdg-utils less 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        alpine)
            log_info "Bootstrapping Alpine Linux..."
            
            # Update package lists
            log_info "Updating package lists..."
            apk update 2>/dev/null || true
            log_success "Package lists updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            apk add --no-cache \
                build-base git curl wget sudo vim \
                man-db man-pages openssh-client unzip zip \
                tar gzip xdg-utils less bash 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        void)
            log_info "Bootstrapping Void Linux..."
            
            # Update system
            log_info "Updating system packages..."
            xbps-install -Syu 2>/dev/null || true
            log_success "System updated"
            
            # Install essential packages
            log_info "Installing essential packages..."
            xbps-install -y \
                base-devel git curl wget sudo vim \
                man-db man-pages openssh unzip zip \
                tar gzip xdg-utils 2>/dev/null || true
            log_success "Essential packages installed"
            ;;
            
        nixos)
            log_info "NixOS detected - packages managed by NixOS configuration"
            log_success "Skipping package installation on NixOS"
            ;;
            
        *)
            log_warn "Unknown distribution: $DISTRO"
            log_info "Attempting generic setup..."
            
            # Try common package managers
            if command -v apt-get &>/dev/null; then
                apt-get update && apt-get install -y sudo git curl 2>/dev/null || true
            elif command -v dnf &>/dev/null; then
                dnf install -y sudo git curl 2>/dev/null || true
            elif command -v pacman &>/dev/null; then
                pacman -S --noconfirm sudo git curl 2>/dev/null || true
            fi
            ;;
    esac
    
    # ========================================================================
    # CONFIGURE LOCALES
    # ========================================================================
    log_info "Configuring locales..."
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            if [ -f /etc/locale.gen ]; then
                sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen 2>/dev/null || true
                locale-gen 2>/dev/null || true
            fi
            if [ ! -f /etc/locale.conf ]; then
                echo "LANG=en_US.UTF-8" > /etc/locale.conf
            fi
            ;;
        ubuntu|debian|linuxmint|pop)
            locale-gen en_US.UTF-8 2>/dev/null || true
            update-locale LANG=en_US.UTF-8 2>/dev/null || true
            ;;
        fedora|rhel|centos|rocky|almalinux)
            localectl set-locale LANG=en_US.UTF-8 2>/dev/null || true
            ;;
    esac
    log_success "Locales configured"
    
    # ========================================================================
    # OPTIMIZE PACKAGE MANAGER
    # ========================================================================
    log_info "Optimizing package manager..."
    case "$DISTRO" in
        arch|archlinux|endeavouros|manjaro)
            if [ -f /etc/pacman.conf ]; then
                sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 10/' /etc/pacman.conf 2>/dev/null || true
                sed -i 's/#Color/Color/' /etc/pacman.conf 2>/dev/null || true
                sed -i 's/#VerbosePkgLists/VerbosePkgLists/' /etc/pacman.conf 2>/dev/null || true
            fi
            ;;
        fedora|rhel|centos|rocky|almalinux)
            if [ -f /etc/dnf/dnf.conf ]; then
                grep -q "^fastestmirror=" /etc/dnf/dnf.conf || echo "fastestmirror=True" >> /etc/dnf/dnf.conf
                grep -q "^max_parallel_downloads=" /etc/dnf/dnf.conf || echo "max_parallel_downloads=10" >> /etc/dnf/dnf.conf
            fi
            ;;
    esac
    log_success "Package manager optimized"
    
    log_success "âœ… Bootstrap phase complete"
    log_info ""
    log_info "System is now ready. Chezmoi will continue with regular setup."
    log_info ""
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  âœ… Bootstrap Phase Complete${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
{{ end -}}