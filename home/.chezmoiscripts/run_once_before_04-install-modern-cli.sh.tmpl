{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 04-INSTALL-MODERN-CLI
# Modern CLI replacements: eza, bat, ripgrep, fd, delta, btop, etc.
# ==============================================================================

set -euo pipefail

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
NC='\033[0m'

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  ⚡ Installing Modern CLI Tools${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# ============================================================================
# SUDO WRAPPER
# ============================================================================
if [ "$(id -u)" -eq 0 ]; then
    SUDO=""
else
    SUDO="sudo"
fi

# ============================================================================
# PACKAGE MANAGER DETECTION
# ============================================================================
if command -v paru &>/dev/null; then
    PKG_INSTALL="paru -S --needed --noconfirm"
elif command -v yay &>/dev/null; then
    PKG_INSTALL="yay -S --needed --noconfirm"
elif command -v pacman &>/dev/null; then
    PKG_INSTALL="$SUDO pacman -S --needed --noconfirm"
elif command -v apt-get &>/dev/null; then
    PKG_INSTALL="$SUDO apt-get install -y"
elif command -v dnf &>/dev/null; then
    PKG_INSTALL="$SUDO dnf install -y"
else
    echo "No supported package manager found!"
    exit 1
fi

# Modern CLI replacements
if command -v pacman &>/dev/null; then
    # Arch Linux packages
    CLI_PKGS=(
        eza bat ripgrep fd
        btop dust duf procs
        git-delta lazygit
        yazi zellij
        neovim mise
        fastfetch
    )
    $PKG_INSTALL "${CLI_PKGS[@]}" &>/dev/null
elif command -v apt-get &>/dev/null; then
    # Ubuntu/Debian packages
    $SUDO apt-get update &>/dev/null
    CLI_PKGS=(
        bat ripgrep fd-find
        btop
        neovim
    )
    $PKG_INSTALL "${CLI_PKGS[@]}" &>/dev/null
    
    # Install eza from cargo or build from source if not in repos
    if ! command -v eza &>/dev/null && command -v cargo &>/dev/null; then
        cargo install eza &>/dev/null || true
    fi
    
    # Install lazygit from GitHub if not in repos
    if ! command -v lazygit &>/dev/null; then
        LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
        curl -sLo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
        $SUDO tar xf /tmp/lazygit.tar.gz -C /usr/local/bin lazygit
        rm /tmp/lazygit.tar.gz
    fi
    
elif command -v dnf &>/dev/null; then
    # Fedora/RHEL packages
    CLI_PKGS=(
        eza bat ripgrep fd-find
        btop
        neovim
        git-delta
    )
    $PKG_INSTALL "${CLI_PKGS[@]}" &>/dev/null
    
    # Install lazygit from copr if available
    if ! command -v lazygit &>/dev/null; then
        $SUDO dnf copr enable atim/lazygit -y &>/dev/null || true
        $PKG_INSTALL lazygit &>/dev/null || {
            # Fallback to GitHub release
            LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
            curl -sLo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
            $SUDO tar xf /tmp/lazygit.tar.gz -C /usr/local/bin lazygit
            rm /tmp/lazygit.tar.gz
        }
    fi
fi

echo -e "${GREEN}✓ Modern CLI tools installed${NC}"
{{ end -}}
