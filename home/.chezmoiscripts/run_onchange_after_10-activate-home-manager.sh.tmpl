{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ==============================================================================
# 10-ACTIVATE-HOME-MANAGER (Universal - 2025/2026 Best Practices - FIXED)
# Automatically builds and activates Home Manager configuration
# Triggers on: flake.nix, home.nix, home-minimal.nix changes
# ==============================================================================

set -euo pipefail

# Configuration hash (triggers re-run on changes)
# flake.nix hash: {{ include "dot_config/home-manager/flake.nix" | sha256sum }}
# home.nix hash: {{ include "dot_config/home-manager/home.nix" | sha256sum }}
# home-minimal.nix hash: {{ include "dot_config/home-manager/home-minimal.nix" | sha256sum }}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[‚úì]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${CYAN}  üè† Home Manager Activation${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# ==============================================================================
# Check prerequisites
# ==============================================================================

# Source Nix environment if available
for profile in \
    "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" \
    "/etc/profile.d/nix.sh" \
    "$HOME/.nix-profile/etc/profile.d/nix.sh"
do
    if [ -e "$profile" ]; then
        . "$profile"
        break
    fi
done

if ! command -v nix &>/dev/null; then
    log_warn "Nix not installed - skipping Home Manager activation"
    log_info "Run the Nix installation script first, then re-run chezmoi apply"
    exit 0
fi

# Check if Home Manager config exists
HM_CONFIG_DIR="$HOME/.config/home-manager"

if [ ! -f "$HM_CONFIG_DIR/flake.nix" ]; then
    log_warn "No Home Manager flake.nix found at $HM_CONFIG_DIR"
    log_info "Home Manager configuration will be set up on next chezmoi apply"
    exit 0
fi

# ==============================================================================
# Determine configuration to use
# ==============================================================================

# Get current username
CURRENT_USER="{{ .chezmoi.username }}"

# Check for minimal mode
MINIMAL_MODE=false
{{ if or .is_codespaces .is_devcontainer -}}
MINIMAL_MODE=true
{{ end -}}

if [ "$MINIMAL_MODE" = "true" ]; then
    HM_CONFIG_NAME="${CURRENT_USER}-minimal"
    log_info "Using minimal configuration: $HM_CONFIG_NAME"
else
    HM_CONFIG_NAME="${CURRENT_USER}"
    log_info "Using full configuration: $HM_CONFIG_NAME"
fi

# ==============================================================================
# Build and Activate Configuration (FIXED: Simplified approach)
# ==============================================================================

cd "$HM_CONFIG_DIR"

log_info "Building Home Manager configuration..."
log_info "This may take a few minutes on first run..."

# FIXED: Use direct home-manager command with proper flake reference
SWITCH_SUCCESS=false

# Method 1: Try with home-manager if available
if command -v home-manager &>/dev/null; then
    log_info "Attempting activation with home-manager command..."
    if home-manager switch --flake ".#${HM_CONFIG_NAME}" 2>&1 | tee /tmp/hm-switch.log; then
        SWITCH_SUCCESS=true
        log_success "Home Manager activated successfully!"
    else
        log_warn "Failed with config name: ${HM_CONFIG_NAME}, trying fallback..."
        if home-manager switch --flake ".#${CURRENT_USER}" 2>&1 | tee -a /tmp/hm-switch.log; then
            SWITCH_SUCCESS=true
            log_success "Home Manager activated with fallback config!"
        fi
    fi
fi

# Method 2: Try with nix run if home-manager command not available
if [ "$SWITCH_SUCCESS" = "false" ] && ! command -v home-manager &>/dev/null; then
    log_info "Installing and running home-manager via nix..."
    if nix run home-manager/master -- switch --flake ".#${HM_CONFIG_NAME}" 2>&1 | tee /tmp/hm-switch.log; then
        SWITCH_SUCCESS=true
        log_success "Home Manager activated successfully!"
    else
        log_warn "Failed with config name: ${HM_CONFIG_NAME}, trying fallback..."
        if nix run home-manager/master -- switch --flake ".#${CURRENT_USER}" 2>&1 | tee -a /tmp/hm-switch.log; then
            SWITCH_SUCCESS=true
            log_success "Home Manager activated with fallback config!"
        fi
    fi
fi

# Method 3: Try to build and manually activate
if [ "$SWITCH_SUCCESS" = "false" ]; then
    log_warn "Direct activation failed, trying manual build..."
    
    # Try to build the configuration
    if nix build ".#homeConfigurations.${HM_CONFIG_NAME}.activationPackage" 2>&1 | tee -a /tmp/hm-switch.log; then
        log_info "Build succeeded, attempting manual activation..."
        if ./result/activate 2>&1 | tee -a /tmp/hm-switch.log; then
            SWITCH_SUCCESS=true
            log_success "Home Manager manually activated!"
        fi
    else
        log_warn "Failed with config name: ${HM_CONFIG_NAME}, trying fallback..."
        if nix build ".#homeConfigurations.${CURRENT_USER}.activationPackage" 2>&1 | tee -a /tmp/hm-switch.log; then
            if ./result/activate 2>&1 | tee -a /tmp/hm-switch.log; then
                SWITCH_SUCCESS=true
                log_success "Home Manager manually activated with fallback config!"
            fi
        fi
    fi
fi

cd - > /dev/null

# ==============================================================================
# Report status
# ==============================================================================

if [ "$SWITCH_SUCCESS" = "true" ]; then
    log_success "‚ú® Home Manager configuration activated successfully!"
    
    # List some installed packages
    echo ""
    log_info "Sample of installed packages:"
    if command -v eza &>/dev/null; then
        echo "  ‚úì eza (ls replacement)"
    fi
    if command -v bat &>/dev/null; then
        echo "  ‚úì bat (cat replacement)"
    fi
    if command -v ripgrep &>/dev/null; then
        echo "  ‚úì ripgrep (grep replacement)"
    fi
    if command -v starship &>/dev/null; then
        echo "  ‚úì starship (prompt)"
    fi
    if command -v atuin &>/dev/null; then
        echo "  ‚úì atuin (history)"
    fi
    echo ""
else
    log_error "‚ùå Home Manager activation failed"
    log_info ""
    log_info "Debug information saved to: /tmp/hm-switch.log"
    log_info ""
    log_info "To troubleshoot:"
    log_info "  1. Check the log file: cat /tmp/hm-switch.log"
    log_info "  2. Validate the flake: cd ~/.config/home-manager && nix flake check"
    log_info "  3. Try manual activation:"
    log_info "     cd ~/.config/home-manager"
    log_info "     home-manager switch --flake .#${CURRENT_USER}"
    log_info ""
    exit 1
fi
{{ end -}}